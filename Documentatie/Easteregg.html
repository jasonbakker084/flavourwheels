<!DOCTYPE html>
<!--versie 2.0
-arrow functions gebruikt
-zoveel for loops vervangen.
-namen van variabelen verbetert
-herschrijven/versimpelen van selecteren en Deselecteren
-optie parentSliceAutoDeSelect verwijderd
-animatie langzame opbouw wiel verwijderd
-Voorzien van heel veel commentaar
TODO: zwarte text op lichte ondergrond
TODO: links of midden uitlijning text ring 2 en 3
TODO: variabel maken van lijndikte e.d. ?

-->

<html lang=nl>
<head>
	<meta charset=utf-8>
	<title>Test coffee flavor wheel svg</title>
	<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
	<style>
		text{
			font-family: arial;
			font-size:7px;
		}

	</style>
</head>
<body>
<!-- SVG = Scalable Vector Graphics hier wordt de ring later in gezet. -->
<!--zet width hoger voor groter wiel -->
<svg id="svgC" width="67%"  viewBox="0 20 600 600">
	<defs>
		<pattern id="center1" patternUnits="userSpaceOnUse" x="-30" y="-30" width="105" height="105">
			<image href="cup05.jpg" x="0" y="0" width="100" height="100" />
		</pattern>
		<pattern id="center2" patternUnits="userSpaceOnUse" x="-11" y="-11" width="95" height="95">
			<image xlink:href="cup02.gif" x="-1" y="0" width="100" height="100" />
		</pattern>
		<pattern id="center3" patternUnits="userSpaceOnUse" x="-11" y="-11" width="95" height="95">
			<image xlink:href="cup03.gif" x="-25" y="-5" width="140" height="140" />
		</pattern>
		<pattern id="center4" patternUnits="userSpaceOnUse" x="-23" y="-24" width="102" height="102">
		<image href="coffeebeans.png" x="-55" y="-55" width="212" height="212" />
</pattern>
		<filter id="shade" x="0" y="0" width="200%" height="200%">
      <feOffset result="offOut" in="SourceGraphic" dx="1" dy="20" />
      <feColorMatrix result="matrixOut" in="offOut" type="matrix"
      values="0.2 0 0 0 0 0 0.2 0 0 0 0 0 0.2 0 0 0 0 0 1 0" />
      <feGaussianBlur result="blurOut" in="matrixOut" stdDeviation="10" />
      <feBlend in="SourceGraphic" in2="blurOut" mode="normal" />
    </filter>
		<filter id="dropshadow" width = "160%" height="160%">
			<feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
			<feOffset dx="4" dy="4" result="offsetblur"/>
			<feMerge>
				<feMergeNode/>
				<feMergeNode in="SourceGraphic"/>
			</feMerge>
		</filter>
  </defs>

  <circle onclick="resetWheel()" id ="test" cx="230" cy="230" r="50" stroke="#000000" stroke-width="0" fill="blue"/>

</svg>
<script>

	const innerRadii =[49,90,145];		//lijst met binnenstralen van elke ring
	const outerRadii =[90,175,200];		//lijst met buitenstralen van elke ring
	const ringnr = 2;									//aantal ringen (kan ook berekend worden)
	const steps =9;									//Aantal stapjes
	const circlex=230;								//coördinaten van het midden van het wiel
	const circley=230;

	//gedraginstellingen
	const parentSliceAutoSelect = true;			//hogere smaak gaat mee omhoog
	const childSliceAutoDeselect = true;   //subsmaak gaat mee omlaag

	const wheelSVG = document.getElementById("svgC");


	/*hier gaan we voor elke ring twee groepen maken
	even getallen voor onaangeklikten en oneven voor aangeklikten (met schaduw)
	bij klikken springt een stukje van de één naar de ander.
	door de volgorde van de groepen, valt schaduw alleen op een grotere ring	*/
	for (let i = (ringnr*2); i > 0; i--){
		const id = "g"+(i);
		const newGroup = document.createElementNS("http://www.w3.org/2000/svg", 'g');
		newGroup.setAttribute("id", (id));
		//alle oneven groepen krijgen schaduw en verschuiving.
		if (i%2 >0){
			newGroup.setAttribute('transform', "scale(1.03), translate(-8,-8)");
			newGroup.setAttribute("filter", "url(#dropshadow)");
		}
		wheelSVG.appendChild(newGroup);

	}
	const SVGBackup = wheelSVG.innerHTML; //backup maken om snel het wiel te wissen
	const flavorList = [{ring:1, fromStep:0, toStep:2, color:"#018532", name:"Denis Haverhals", id:1, parentID:0},
{ring:2, fromStep:0, toStep:1, color:"#C0C703", name:"Inleiding programmeren", id:2, parentID:1},
{ring:2, fromStep:1, toStep:2, color:"#9BBB0E", name:"Java", id:3, parentID:1},
{ring:1, fromStep:2, toStep:5, color:"#2B2146", name:"Erik Mols", id:4, parentID:0},
{ring:2, fromStep:2, toStep:3, color:"#966DAF", name:"Java2 ", id:5, parentID:4},
{ring:2, fromStep:3, toStep:4, color:"#8878B7", name:"React", id:6, parentID:4},
{ring:2, fromStep:4, toStep:5, color:"#655AA8", name:"Begeleid werken", id:7, parentID:4},
{ring:1, fromStep:5, toStep:8, color:"#641706", name:"Jeroen baten", id:8, parentID:0},
{ring:2, fromStep:5, toStep:6, color:"#D37378", name:"HTML", id:9, parentID:8},
{ring:2, fromStep:6, toStep:7, color:"#F7807F", name:"CSS", id:10, parentID:8},
{ring:2, fromStep:7, toStep:8, color:"#F71E1F", name:"Javascript", id:11, parentID:8},
{ring:1, fromStep:8, toStep:9, color:"#D0A401", name:"Ruud Markus", id:12, parentID:0},
{ring:2, fromStep:8, toStep:9, color:"#DFB001", name:"Project management", id:13, parentID:12},
]

	//Teken het wiel, door voor elke flavor drawSlice() aan te roepen.
	const drawWheel = () => flavorList.map( flavor => drawSlice(flavor) );

	//Teken de slice
  const drawSlice = ( {ring, fromStep,toStep, color, name, id} ) => {
		//benoem in één keer 6 variabelen, uit de flavor te halen
		//name = name.toUpperCase();

		//Staal en hoeken bepalen.
		const innerRadius = innerRadii[ring-1];			//straal van binnenste boog
		const outerRadius = outerRadii[ring-1];			//straal van buitenste boog
		const Angle1 = (fromStep/steps)*2*Math.PI;	//hoek waar de slice begint
		const Angle2 = (toStep/steps)*2*Math.PI;		//hoek waar de slice eindigt


		//Elke slice heeft 4 punten/hoeken, dus 4 x,y coordinaten.
		const x1 = (circlex + (Math.sin(Angle1)*innerRadius));
		const y1 = (circley - (Math.cos(Angle1)*innerRadius));
		const x2 = (circlex + (Math.sin(Angle1)*outerRadius));
		const y2 = (circley - (Math.cos(Angle1)*outerRadius));
		const x3 = (circlex + (Math.sin(Angle2)*outerRadius));
		const y3 = (circley - (Math.cos(Angle2)*outerRadius));
		const x4 = (circlex + (Math.sin(Angle2)*innerRadius));
		const y4 = (circley - (Math.cos(Angle2)*innerRadius));

		//DE SVGCODE VOOR HET TEKENEN
		//1. ga naar punt 1 - M=move
		//2. trek vanaf daar een rechte lijn naar punt 2 - L=line
		//3. teken vanaf daar een grote boog naar punt 3 - A=arch
		//4. teken vanaf daar een rechte lijn naar punt 4 - L
		//5. teken vanaf daar een kleine boog terug naar punt 1 - A
		const pathString =
		"M" + x1 + " " +y1 +																						//1
		"L "+x2+" "+y2 +																								//2
		"A"+ outerRadius + 		" "+outerRadius + " 1 0 1 "+x3 + " "+y3 +	//3
		"L"+x4+" "+y4 +																									//4
		"A"+ innerRadius +" " + innerRadius+ " 0 0 0 " + x1 + " " +y1;	//5

		//hier wordt het tekeningetje van de slice in elkaar gezet
		const newPath = document.createElementNS("http://www.w3.org/2000/svg", 'path');
		newPath.setAttribute("d", pathString);

		//HET MAKEN EN PLAATSEN VAN DE TEKST VAN DE NAMEN.
		//de tekst voor in de ringen word in verschillende stapppen gemaakt:
		//1. maak een elemeent met de text van de flavor
		const newText = document.createElementNS("http://www.w3.org/2000/svg", 'text');
		//2. zet de x en de y eerst het in het midden van het wiel
		newText.setAttribute("x", circlex);
		newText.setAttribute("y", circley);

		newText.setAttribute("alignment-baseline", "middle");

		//3. bepaal de hoek van de tekst
		//er wordt (ongeveer) 90 graden vanaf getrokken, omdat de tekst
		//natuurlijk eerst horizontaal staat, dus al 90 graden gedraaid.
		const angle = (((fromStep+toStep)/steps)*180)-90;
		let textAngle = angle;
		//4. kleine correctie voor de tekst die voorbij het onderste punt komt.
		if(angle>90){
			textAngle=angle-(0.2);
		}

		//5. Bepaal hoever de teks van het midden moet staan.

		//6. maak een string waarin de transformaties uit de vorige stappen staan
		var transformString = "rotate("+textAngle+" "+circlex+" "+circley+"),";
		//transformString += "translate("+textX+")";
		//7. in de binnenste ring moet de tekst dwars staan, dus meer berekenigen
		if (ring==1){
				//8. verder van het midden af
				let textX= ((innerRadius+outerRadius)/1.82	)
				let textXCorrection = 0;
				transformString += "translate("+textX+")";

				//9. in de onderste helft moet alles een kwartslag terug
				if (angle > 0 && angle < 180 ){
					transformString += "rotate(-90 "+circlex+" "+circley+")";
					textXCorrection = -5.5
				}
				//10. in de bovenste helft moet alles een kwartslag verder
				if (angle > 180 || angle < 0 ){
					transformString += "rotate(90 "+circlex+" "+circley+")";
				//	transformString += "translate(1)";
				}
				//11. de tekst moet in het midden worden uitgelijnd.
				newText.setAttribute("text-anchor", "middle");
				//12. Kijk of er een "/" in de naam staat.
				let division = name.indexOf("/");
				if (division ==-1){
					newText.innerHTML = name;
				}
				//13. Zo ja, breek hem af.
				else {
					let namepart1 = name.substring(0,division+1);
					let namepart2 = name.substring(division+1,name.length);
					//14. Zet eerst het eerste deel neer
					let newSpan1 = document.createElementNS("http://www.w3.org/2000/svg", 'tspan');
					newSpan1.innerHTML = namepart1;
					newSpan1.setAttribute("x", circlex);
					newSpan1.setAttribute("dy", textXCorrection);
					newText.appendChild(newSpan1);
					//newText.innerHTML = namepart1;
					//15. maak dan een apart vakje onder het eerste deel voor het tweede.
					let newSpan2 = document.createElementNS("http://www.w3.org/2000/svg", 'tspan');
					newSpan2.innerHTML = namepart2;
					newSpan2.setAttribute("x", circlex);
					newSpan2.setAttribute("dy", "6");
					newText.appendChild(newSpan2);
				}

		}
		//15. in andere ringen moet sommige tekst ook rechtopgedraaid worden
		else{
			let textX= outerRadius-3
			transformString += "translate("+textX+")";
			//16. voorbij het onderste punt? dan op zijn kop zetten en
			//rechts uitlijnen in plaat van links
			if(angle>90){
				//newText.setAttribute("text-anchor", "start");
				let textX= outerRadius-5

				transformString += "rotate(180 "+circlex+" "+circley+")";
			}
			else{
				newText.setAttribute("text-anchor", "end");

			}
			newText.innerHTML = name;
		}



		//17. de transformatie toepassen. Lijndikte en kleur bepalen.
		newText.setAttribute('transform', transformString);

		newText.style.strokeWidth = "0px"; // geen lijn om tekst
		let lineAndTextColor = "white";
		if (isColorLight(color)){
			lineAndTextColor = "black";
		  newText.style.strokeWidth = "0.3px";
		}
		newText.style.fill = lineAndTextColor;
		newText.style.stroke = lineAndTextColor;

		//18. de Slice maken: maak de nieuwe groep aan met de id van de flavor
		var newGroup = document.createElementNS("http://www.w3.org/2000/svg", 'g');
    newGroup.setAttribute("id", (""+id));
		newGroup.setAttribute("class", "slice");
		newGroup.setAttribute("onclick","clickAction(this)");
	  newGroup.style.stroke = "white";
		newGroup.style.fill = color;
		newPath.style.strokeWidth = "0.5px";
		//19. zet de tekening en de tekst in deze groep
		newGroup.appendChild(newPath);
		newGroup.appendChild(newText);

		//20. Zet die groep vervolgens in de juiste ringgroep.
		var parentGroupID = ("g"+(ring*2));
	  document.getElementById(parentGroupID).appendChild(newGroup);
	}

	//Bepaal of een kleur licht is (zodat witte letters er niet op te lezen zijn)
	//naar voorbeeld https://awik.io/determine-color-bright-dark-using-javascript/
	const isColorLight = (color) => {
		let r = parseInt(color.substring(1,3), 16);
		let g = parseInt(color.substring(3,5), 16);
		let b = parseInt(color.substring(5,7), 16);
		hsp = Math.sqrt(
			0.299 * (r * r) +
			0.587 * (g * g) +
			0.114 * (b * b)
		);
		return (hsp>210);
	}

	let test = isColorLight("#F7F1BD");

	//Klikactie voor een slice: moet ie geselecteerd worden of geDEselecteerd?
	const clickAction = (slice) => {
		(isSelected(slice)) ? deselectSlice(slice) : selectSlice(slice) };


	//selecteren van een slice = in een group plaatsen met hoger nummer
	const selectSlice = (slice) => {
		if (!isSelected(slice)){
			document.getElementById(getHigherGroupId(slice)).appendChild(slice);
			//Heeft ie een parent? en staat de optie op true, dan ook selecteren:
			if (getGroupNumber(slice)>2 && parentSliceAutoSelect){
				selectSlice(getParentSlice(slice));
			}
		}
	}

	//Deselecteren van een slice = in een group plaatsen met lager nummer
	const  deselectSlice = (slice) => {
		document.getElementById(getLowerGroupId(slice)).appendChild(slice);
		//staat de optie aan om children ook te Deselecteren, doe die dan ook.
		if (childSliceAutoDeselect){
			getSelectedChildrenSlices(slice).map( (ChildSlice) => deselectSlice(ChildSlice));
		}
	}

	//backup HTML in SVG terugzetten = leegmaken en dan opnieuw tekenen
	const resetWheel= () => {
		wheelSVG.innerHTML = SVGBackup;
		drawWheel();
	}

	//het nummer van de groep. Ze heten "g1", "g2", etc, dus hak de "g" eraf.
	const getGroupNumber = (slice) =>  parseInt((slice.parentNode.id).replace("g",""));

	//Het id van een groep hoger. g2=g1, etc
	const getHigherGroupId = (slice) => `g${getGroupNumber(slice)-1}`;

	//Het id van een groep lager. g1=g2, etc
	const getLowerGroupId = (slice) => `g${getGroupNumber(slice)+1}`;

	//is deze geselecteerd? dat ziet ie door een oneven groepnummer
	const isSelected = (slice) => getGroupNumber(slice)%2>0;

	//zoekt in flavorList naar ID van de parentSlice
	const getParentSliceID = (sliceID) => {
		return (flavorList.find( (listpart) =>
			listpart.id == sliceID
		).parentID);
	}

	//Zoek het daadwerkelijke element van de parent.
	const getParentSlice = (slice) =>
		document.getElementById(getParentSliceID(slice.id));


	//Onderstaande functie krijgt een slice mee en geeft een lijst terug met
	//de children van deze slice die geselecteerd zijn. Dat gaat zo:
	//1. neem de flavorList en filter daar alleen de flavors uit die
	//onder deze vallen (ParentID == sliceid).
	//2. neem daarvan niet de hele flavor, maar de id
	//3. zoek de daadwerkelijke elementen met die id.
	//4. filter alleen de elementen die geselecteerd zijn.
	const getSelectedChildrenSlices = (slice) => {
		return flavorList.filter( (flavor) =>  flavor.parentID == slice.id ) 	//1
			.map( (flavor) =>  flavor.id )																			//2
				.map ( (id) => document.getElementById(id) ).											//3
					filter( (element) => isSelected(element) );											//4
	}
  drawWheel();
</script>
</body>
</html>
